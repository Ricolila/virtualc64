\doxysection{wave.\+h}
\hypertarget{wave_8h_source}{}\label{wave_8h_source}\index{/Users/hoff/Retro/virtualc64/Emulator/Components/SID/resid/wave.h@{/Users/hoff/Retro/virtualc64/Emulator/Components/SID/resid/wave.h}}

\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{//\ \ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00002\ \textcolor{comment}{//\ \ This\ file\ is\ part\ of\ reSID,\ a\ MOS6581\ SID\ emulator\ engine.}}
\DoxyCodeLine{00003\ \textcolor{comment}{//\ \ Copyright\ (C)\ 2010\ \ Dag\ Lem\ <resid@nimrod.no>}}
\DoxyCodeLine{00004\ \textcolor{comment}{//}}
\DoxyCodeLine{00005\ \textcolor{comment}{//\ \ This\ program\ is\ free\ software;\ you\ can\ redistribute\ it\ and/or\ modify}}
\DoxyCodeLine{00006\ \textcolor{comment}{//\ \ it\ under\ the\ terms\ of\ the\ GNU\ General\ Public\ License\ as\ published\ by}}
\DoxyCodeLine{00007\ \textcolor{comment}{//\ \ the\ Free\ Software\ Foundation;\ either\ version\ 2\ of\ the\ License,\ or}}
\DoxyCodeLine{00008\ \textcolor{comment}{//\ \ (at\ your\ option)\ any\ later\ version.}}
\DoxyCodeLine{00009\ \textcolor{comment}{//}}
\DoxyCodeLine{00010\ \textcolor{comment}{//\ \ This\ program\ is\ distributed\ in\ the\ hope\ that\ it\ will\ be\ useful,}}
\DoxyCodeLine{00011\ \textcolor{comment}{//\ \ but\ WITHOUT\ ANY\ WARRANTY;\ without\ even\ the\ implied\ warranty\ of}}
\DoxyCodeLine{00012\ \textcolor{comment}{//\ \ MERCHANTABILITY\ or\ FITNESS\ FOR\ A\ PARTICULAR\ PURPOSE.\ \ See\ the}}
\DoxyCodeLine{00013\ \textcolor{comment}{//\ \ GNU\ General\ Public\ License\ for\ more\ details.}}
\DoxyCodeLine{00014\ \textcolor{comment}{//}}
\DoxyCodeLine{00015\ \textcolor{comment}{//\ \ You\ should\ have\ received\ a\ copy\ of\ the\ GNU\ General\ Public\ License}}
\DoxyCodeLine{00016\ \textcolor{comment}{//\ \ along\ with\ this\ program;\ if\ not,\ write\ to\ the\ Free\ Software}}
\DoxyCodeLine{00017\ \textcolor{comment}{//\ \ Foundation,\ Inc.,\ 59\ Temple\ Place,\ Suite\ 330,\ Boston,\ MA\ \ 02111-\/1307\ \ USA}}
\DoxyCodeLine{00018\ \textcolor{comment}{//\ \ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#ifndef\ RESID\_WAVE\_H}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#define\ RESID\_WAVE\_H}}
\DoxyCodeLine{00022\ }
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ "{}resid-\/config.h"{}}}
\DoxyCodeLine{00024\ }
\DoxyCodeLine{00025\ \textcolor{keyword}{namespace\ }reSID}
\DoxyCodeLine{00026\ \{}
\DoxyCodeLine{00027\ }
\DoxyCodeLine{00028\ \textcolor{comment}{//\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00029\ \textcolor{comment}{//\ A\ 24\ bit\ accumulator\ is\ the\ basis\ for\ waveform\ generation.\ FREQ\ is\ added\ to}}
\DoxyCodeLine{00030\ \textcolor{comment}{//\ the\ lower\ 16\ bits\ of\ the\ accumulator\ each\ cycle.}}
\DoxyCodeLine{00031\ \textcolor{comment}{//\ The\ accumulator\ is\ set\ to\ zero\ when\ TEST\ is\ set,\ and\ starts\ counting}}
\DoxyCodeLine{00032\ \textcolor{comment}{//\ when\ TEST\ is\ cleared.}}
\DoxyCodeLine{00033\ \textcolor{comment}{//\ The\ noise\ waveform\ is\ taken\ from\ intermediate\ bits\ of\ a\ 23\ bit\ shift}}
\DoxyCodeLine{00034\ \textcolor{comment}{//\ register.\ This\ register\ is\ clocked\ by\ bit\ 19\ of\ the\ accumulator.}}
\DoxyCodeLine{00035\ \textcolor{comment}{//\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00036\ \textcolor{keyword}{class\ }WaveformGenerator}
\DoxyCodeLine{00037\ \{}
\DoxyCodeLine{00038\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00039\ \ \ WaveformGenerator();}
\DoxyCodeLine{00040\ }
\DoxyCodeLine{00041\ \ \ \textcolor{keywordtype}{void}\ set\_sync\_source(WaveformGenerator*);}
\DoxyCodeLine{00042\ \ \ \textcolor{keywordtype}{void}\ set\_chip\_model(chip\_model\ model);}
\DoxyCodeLine{00043\ }
\DoxyCodeLine{00044\ \ \ \textcolor{keywordtype}{void}\ clock();}
\DoxyCodeLine{00045\ \ \ \textcolor{keywordtype}{void}\ clock(cycle\_count\ delta\_t);}
\DoxyCodeLine{00046\ \ \ \textcolor{keywordtype}{void}\ synchronize();}
\DoxyCodeLine{00047\ \ \ \textcolor{keywordtype}{void}\ reset();}
\DoxyCodeLine{00048\ }
\DoxyCodeLine{00049\ \ \ \textcolor{keywordtype}{void}\ writeFREQ\_LO(reg8);}
\DoxyCodeLine{00050\ \ \ \textcolor{keywordtype}{void}\ writeFREQ\_HI(reg8);}
\DoxyCodeLine{00051\ \ \ \textcolor{keywordtype}{void}\ writePW\_LO(reg8);}
\DoxyCodeLine{00052\ \ \ \textcolor{keywordtype}{void}\ writePW\_HI(reg8);}
\DoxyCodeLine{00053\ \ \ \textcolor{keywordtype}{void}\ writeCONTROL\_REG(reg8);}
\DoxyCodeLine{00054\ \ \ reg8\ readOSC();}
\DoxyCodeLine{00055\ }
\DoxyCodeLine{00056\ \ \ \textcolor{comment}{//\ 12-\/bit\ waveform\ output.}}
\DoxyCodeLine{00057\ \ \ \textcolor{keywordtype}{short}\ output();}
\DoxyCodeLine{00058\ }
\DoxyCodeLine{00059\ \ \ \textcolor{comment}{//\ Calculate\ and\ set\ waveform\ output\ value.}}
\DoxyCodeLine{00060\ \ \ \textcolor{keywordtype}{void}\ set\_waveform\_output();}
\DoxyCodeLine{00061\ \ \ \textcolor{keywordtype}{void}\ set\_waveform\_output(cycle\_count\ delta\_t);}
\DoxyCodeLine{00062\ }
\DoxyCodeLine{00063\ \textcolor{keyword}{protected}:}
\DoxyCodeLine{00064\ \ \ \textcolor{keywordtype}{void}\ clock\_shift\_register();}
\DoxyCodeLine{00065\ \ \ \textcolor{keywordtype}{void}\ write\_shift\_register();}
\DoxyCodeLine{00066\ \ \ \textcolor{keywordtype}{void}\ set\_noise\_output();}
\DoxyCodeLine{00067\ \ \ \textcolor{keywordtype}{void}\ wave\_bitfade();}
\DoxyCodeLine{00068\ \ \ \textcolor{keywordtype}{void}\ shiftreg\_bitfade();}
\DoxyCodeLine{00069\ }
\DoxyCodeLine{00070\ \ \ \textcolor{keyword}{const}\ WaveformGenerator*\ sync\_source;}
\DoxyCodeLine{00071\ \ \ WaveformGenerator*\ sync\_dest;}
\DoxyCodeLine{00072\ }
\DoxyCodeLine{00073\ \ \ reg24\ accumulator;}
\DoxyCodeLine{00074\ }
\DoxyCodeLine{00075\ \ \ \textcolor{comment}{//\ Tell\ whether\ the\ accumulator\ MSB\ was\ set\ high\ on\ this\ cycle.}}
\DoxyCodeLine{00076\ \ \ \textcolor{keywordtype}{bool}\ msb\_rising;}
\DoxyCodeLine{00077\ }
\DoxyCodeLine{00078\ \ \ \textcolor{comment}{//\ Fout\ \ =\ (Fn*Fclk/16777216)Hz}}
\DoxyCodeLine{00079\ \ \ \textcolor{comment}{//\ reg16\ freq;}}
\DoxyCodeLine{00080\ \ \ reg24\ freq;}
\DoxyCodeLine{00081\ \ \ \textcolor{comment}{//\ PWout\ =\ (PWn/40.95)\%}}
\DoxyCodeLine{00082\ \ \ reg12\ pw;}
\DoxyCodeLine{00083\ }
\DoxyCodeLine{00084\ \ \ reg24\ shift\_register;}
\DoxyCodeLine{00085\ }
\DoxyCodeLine{00086\ \ \ \textcolor{comment}{//\ Remaining\ time\ to\ fully\ reset\ shift\ register.}}
\DoxyCodeLine{00087\ \ \ cycle\_count\ shift\_register\_reset;}
\DoxyCodeLine{00088\ \ \ \textcolor{comment}{//\ Emulation\ of\ pipeline\ causing\ bit\ 19\ to\ clock\ the\ shift\ register.}}
\DoxyCodeLine{00089\ \ \ cycle\_count\ shift\_pipeline;}
\DoxyCodeLine{00090\ }
\DoxyCodeLine{00091\ \ \ \textcolor{comment}{//\ Helper\ variables\ for\ waveform\ table\ lookup.}}
\DoxyCodeLine{00092\ \ \ reg24\ ring\_msb\_mask;}
\DoxyCodeLine{00093\ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{short}\ no\_noise;}
\DoxyCodeLine{00094\ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{short}\ noise\_output;}
\DoxyCodeLine{00095\ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{short}\ no\_noise\_or\_noise\_output;}
\DoxyCodeLine{00096\ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{short}\ no\_pulse;}
\DoxyCodeLine{00097\ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{short}\ pulse\_output;}
\DoxyCodeLine{00098\ }
\DoxyCodeLine{00099\ \ \ \textcolor{comment}{//\ The\ control\ register\ right-\/shifted\ 4\ bits;\ used\ for\ waveform\ table\ lookup.}}
\DoxyCodeLine{00100\ \ \ reg8\ waveform;}
\DoxyCodeLine{00101\ }
\DoxyCodeLine{00102\ \ \ \textcolor{comment}{//\ 8580\ tri/saw\ pipeline}}
\DoxyCodeLine{00103\ \ \ reg12\ tri\_saw\_pipeline;}
\DoxyCodeLine{00104\ \ \ reg12\ osc3;}
\DoxyCodeLine{00105\ }
\DoxyCodeLine{00106\ \ \ \textcolor{comment}{//\ The\ remaining\ control\ register\ bits.}}
\DoxyCodeLine{00107\ \ \ reg8\ test;}
\DoxyCodeLine{00108\ \ \ reg8\ ring\_mod;}
\DoxyCodeLine{00109\ \ \ reg8\ sync;}
\DoxyCodeLine{00110\ \ \ \textcolor{comment}{//\ The\ gate\ bit\ is\ handled\ by\ the\ EnvelopeGenerator.}}
\DoxyCodeLine{00111\ }
\DoxyCodeLine{00112\ \ \ \textcolor{comment}{//\ DAC\ input.}}
\DoxyCodeLine{00113\ \ \ reg12\ waveform\_output;}
\DoxyCodeLine{00114\ \ \ \textcolor{comment}{//\ Fading\ time\ for\ floating\ DAC\ input\ (waveform\ 0).}}
\DoxyCodeLine{00115\ \ \ cycle\_count\ floating\_output\_ttl;}
\DoxyCodeLine{00116\ }
\DoxyCodeLine{00117\ \ \ chip\_model\ sid\_model;}
\DoxyCodeLine{00118\ }
\DoxyCodeLine{00119\ \ \ \textcolor{comment}{//\ Sample\ data\ for\ waveforms,\ not\ including\ noise.}}
\DoxyCodeLine{00120\ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{short}*\ wave;}
\DoxyCodeLine{00121\ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{short}\ model\_wave[2][8][1\ <<\ 12];}
\DoxyCodeLine{00122\ \ \ \textcolor{comment}{//\ DAC\ lookup\ tables.}}
\DoxyCodeLine{00123\ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{short}\ model\_dac[2][1\ <<\ 12];}
\DoxyCodeLine{00124\ }
\DoxyCodeLine{00125\ \textcolor{keyword}{friend}\ \textcolor{keyword}{class\ }Voice;}
\DoxyCodeLine{00126\ \textcolor{keyword}{friend}\ \textcolor{keyword}{class\ }SID;}
\DoxyCodeLine{00127\ \};}
\DoxyCodeLine{00128\ }
\DoxyCodeLine{00129\ }
\DoxyCodeLine{00130\ \textcolor{comment}{//\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00131\ \textcolor{comment}{//\ Inline\ functions.}}
\DoxyCodeLine{00132\ \textcolor{comment}{//\ The\ following\ functions\ are\ defined\ inline\ because\ they\ are\ called\ every}}
\DoxyCodeLine{00133\ \textcolor{comment}{//\ time\ a\ sample\ is\ calculated.}}
\DoxyCodeLine{00134\ \textcolor{comment}{//\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00135\ }
\DoxyCodeLine{00136\ \textcolor{preprocessor}{\#if\ RESID\_INLINING\ ||\ defined(RESID\_WAVE\_CC)}}
\DoxyCodeLine{00137\ }
\DoxyCodeLine{00138\ \textcolor{comment}{//\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00139\ \textcolor{comment}{//\ SID\ clocking\ -\/\ 1\ cycle.}}
\DoxyCodeLine{00140\ \textcolor{comment}{//\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00141\ RESID\_INLINE}
\DoxyCodeLine{00142\ \textcolor{keywordtype}{void}\ WaveformGenerator::clock()}
\DoxyCodeLine{00143\ \{}
\DoxyCodeLine{00144\ \ \ \textcolor{keywordflow}{if}\ (unlikely(test))\ \{}
\DoxyCodeLine{00145\ \ \ \ \ \textcolor{comment}{//\ Count\ down\ time\ to\ fully\ reset\ shift\ register.}}
\DoxyCodeLine{00146\ \ \ \ \ \textcolor{keywordflow}{if}\ (unlikely(shift\_register\_reset)\ \&\&\ unlikely(!-\/-\/shift\_register\_reset))\ \{}
\DoxyCodeLine{00147\ \ \ \ \ \ \ shiftreg\_bitfade();}
\DoxyCodeLine{00148\ \ \ \ \ \}}
\DoxyCodeLine{00149\ }
\DoxyCodeLine{00150\ \ \ \ \ \textcolor{comment}{//\ The\ test\ bit\ sets\ pulse\ high.}}
\DoxyCodeLine{00151\ \ \ \ \ pulse\_output\ =\ 0xfff;}
\DoxyCodeLine{00152\ \ \ \}}
\DoxyCodeLine{00153\ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00154\ \ \ \ \ \textcolor{comment}{//\ Calculate\ new\ accumulator\ value;}}
\DoxyCodeLine{00155\ \ \ \ \ reg24\ accumulator\_next\ =\ (accumulator\ +\ freq)\ \&\ 0xffffff;}
\DoxyCodeLine{00156\ \ \ \ \ reg24\ accumulator\_bits\_set\ =\ \string~accumulator\ \&\ accumulator\_next;}
\DoxyCodeLine{00157\ \ \ \ \ accumulator\ =\ accumulator\_next;}
\DoxyCodeLine{00158\ }
\DoxyCodeLine{00159\ \ \ \ \ \textcolor{comment}{//\ Check\ whether\ the\ MSB\ is\ set\ high.\ This\ is\ used\ for\ synchronization.}}
\DoxyCodeLine{00160\ \ \ \ \ msb\_rising\ =\ (accumulator\_bits\_set\ \&\ 0x800000)\ ?\ \textcolor{keyword}{true}\ :\ false;}
\DoxyCodeLine{00161\ }
\DoxyCodeLine{00162\ \ \ \ \ \textcolor{comment}{//\ Shift\ noise\ register\ once\ for\ each\ time\ accumulator\ bit\ 19\ is\ set\ high.}}
\DoxyCodeLine{00163\ \ \ \ \ \textcolor{comment}{//\ The\ shift\ is\ delayed\ 2\ cycles.}}
\DoxyCodeLine{00164\ \ \ \ \ \textcolor{keywordflow}{if}\ (unlikely(accumulator\_bits\_set\ \&\ 0x080000))\ \{}
\DoxyCodeLine{00165\ \ \ \ \ \ \ \textcolor{comment}{//\ Pipeline:\ Detect\ rising\ bit,\ shift\ phase\ 1,\ shift\ phase\ 2.}}
\DoxyCodeLine{00166\ \ \ \ \ \ \ shift\_pipeline\ =\ 2;}
\DoxyCodeLine{00167\ \ \ \ \ \}}
\DoxyCodeLine{00168\ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (unlikely(shift\_pipeline)\ \&\&\ !-\/-\/shift\_pipeline)\ \{}
\DoxyCodeLine{00169\ \ \ \ \ \ \ clock\_shift\_register();}
\DoxyCodeLine{00170\ \ \ \ \ \}}
\DoxyCodeLine{00171\ \ \ \}}
\DoxyCodeLine{00172\ \}}
\DoxyCodeLine{00173\ }
\DoxyCodeLine{00174\ \textcolor{comment}{//\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00175\ \textcolor{comment}{//\ SID\ clocking\ -\/\ delta\_t\ cycles.}}
\DoxyCodeLine{00176\ \textcolor{comment}{//\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00177\ RESID\_INLINE}
\DoxyCodeLine{00178\ \textcolor{keywordtype}{void}\ WaveformGenerator::clock(cycle\_count\ delta\_t)}
\DoxyCodeLine{00179\ \{}
\DoxyCodeLine{00180\ \ \ \textcolor{keywordflow}{if}\ (unlikely(test))\ \{}
\DoxyCodeLine{00181\ \ \ \ \ \textcolor{comment}{//\ Count\ down\ time\ to\ fully\ reset\ shift\ register.}}
\DoxyCodeLine{00182\ \ \ \ \ \textcolor{keywordflow}{if}\ (shift\_register\_reset)\ \{}
\DoxyCodeLine{00183\ \ \ \ \ \ \ shift\_register\_reset\ -\/=\ delta\_t;}
\DoxyCodeLine{00184\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (unlikely(shift\_register\_reset\ <=\ 0))\ \{}
\DoxyCodeLine{00185\ \ \ \ \ \ \ \ \ shift\_register\ =\ 0x7fffff;}
\DoxyCodeLine{00186\ \ \ \ \ \ \ \ \ shift\_register\_reset\ =\ 0;}
\DoxyCodeLine{00187\ }
\DoxyCodeLine{00188\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ New\ noise\ waveform\ output.}}
\DoxyCodeLine{00189\ \ \ \ \ \ \ \ \ set\_noise\_output();}
\DoxyCodeLine{00190\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00191\ \ \ \ \ \}}
\DoxyCodeLine{00192\ }
\DoxyCodeLine{00193\ \ \ \ \ \textcolor{comment}{//\ The\ test\ bit\ sets\ pulse\ high.}}
\DoxyCodeLine{00194\ \ \ \ \ pulse\_output\ =\ 0xfff;}
\DoxyCodeLine{00195\ \ \ \}}
\DoxyCodeLine{00196\ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00197\ \ \ \ \ \textcolor{comment}{//\ Calculate\ new\ accumulator\ value;}}
\DoxyCodeLine{00198\ \ \ \ \ reg24\ delta\_accumulator\ =\ delta\_t*freq;}
\DoxyCodeLine{00199\ \ \ \ \ reg24\ accumulator\_next\ =\ (accumulator\ +\ delta\_accumulator)\ \&\ 0xffffff;}
\DoxyCodeLine{00200\ \ \ \ \ reg24\ accumulator\_bits\_set\ =\ \string~accumulator\ \&\ accumulator\_next;}
\DoxyCodeLine{00201\ \ \ \ \ accumulator\ =\ accumulator\_next;}
\DoxyCodeLine{00202\ }
\DoxyCodeLine{00203\ \ \ \ \ \textcolor{comment}{//\ Check\ whether\ the\ MSB\ is\ set\ high.\ This\ is\ used\ for\ synchronization.}}
\DoxyCodeLine{00204\ \ \ \ \ msb\_rising\ =\ (accumulator\_bits\_set\ \&\ 0x800000)\ ?\ \textcolor{keyword}{true}\ :\ false;}
\DoxyCodeLine{00205\ }
\DoxyCodeLine{00206\ \ \ \ \ \textcolor{comment}{//\ NB!\ Any\ pipelined\ shift\ register\ clocking\ from\ single\ cycle\ clocking}}
\DoxyCodeLine{00207\ \ \ \ \ \textcolor{comment}{//\ will\ be\ lost.\ It\ is\ not\ worth\ the\ trouble\ to\ flush\ the\ pipeline\ here.}}
\DoxyCodeLine{00208\ }
\DoxyCodeLine{00209\ \ \ \ \ \textcolor{comment}{//\ Shift\ noise\ register\ once\ for\ each\ time\ accumulator\ bit\ 19\ is\ set\ high.}}
\DoxyCodeLine{00210\ \ \ \ \ \textcolor{comment}{//\ Bit\ 19\ is\ set\ high\ each\ time\ 2\string^20\ (0x100000)\ is\ added\ to\ the\ accumulator.}}
\DoxyCodeLine{00211\ \ \ \ \ reg24\ shift\_period\ =\ 0x100000;}
\DoxyCodeLine{00212\ }
\DoxyCodeLine{00213\ \ \ \ \ \textcolor{keywordflow}{while}\ (delta\_accumulator)\ \{}
\DoxyCodeLine{00214\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (likely(delta\_accumulator\ <\ shift\_period))\ \{}
\DoxyCodeLine{00215\ \ \ \ \ \ \ \ \ shift\_period\ =\ delta\_accumulator;}
\DoxyCodeLine{00216\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Determine\ whether\ bit\ 19\ is\ set\ on\ the\ last\ period.}}
\DoxyCodeLine{00217\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ NB!\ Requires\ two's\ complement\ integer.}}
\DoxyCodeLine{00218\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (likely(shift\_period\ <=\ 0x080000))\ \{}
\DoxyCodeLine{00219\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Check\ for\ flip\ from\ 0\ to\ 1.}}
\DoxyCodeLine{00220\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (((accumulator\ -\/\ shift\_period)\ \&\ 0x080000)\ ||\ !(accumulator\ \&\ 0x080000))}
\DoxyCodeLine{00221\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00222\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00223\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00224\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00225\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00226\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Check\ for\ flip\ from\ 0\ (to\ 1\ or\ via\ 1\ to\ 0)\ or\ from\ 1\ via\ 0\ to\ 1.}}
\DoxyCodeLine{00227\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (((accumulator\ -\/\ shift\_period)\ \&\ 0x080000)\ \&\&\ !(accumulator\ \&\ 0x080000))}
\DoxyCodeLine{00228\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00229\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00230\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00231\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00232\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00233\ }
\DoxyCodeLine{00234\ \ \ \ \ \ \ \textcolor{comment}{//\ Shift\ the\ noise/random\ register.}}
\DoxyCodeLine{00235\ \ \ \ \ \ \ \textcolor{comment}{//\ NB!\ The\ two-\/cycle\ pipeline\ delay\ is\ only\ modeled\ for\ 1\ cycle\ clocking.}}
\DoxyCodeLine{00236\ \ \ \ \ \ \ clock\_shift\_register();}
\DoxyCodeLine{00237\ }
\DoxyCodeLine{00238\ \ \ \ \ \ \ delta\_accumulator\ -\/=\ shift\_period;}
\DoxyCodeLine{00239\ \ \ \ \ \}}
\DoxyCodeLine{00240\ }
\DoxyCodeLine{00241\ \ \ \ \ \textcolor{comment}{//\ Calculate\ pulse\ high/low.}}
\DoxyCodeLine{00242\ \ \ \ \ \textcolor{comment}{//\ NB!\ The\ one-\/cycle\ pipeline\ delay\ is\ only\ modeled\ for\ 1\ cycle\ clocking.}}
\DoxyCodeLine{00243\ \ \ \ \ pulse\_output\ =\ (accumulator\ >>\ 12)\ >=\ pw\ ?\ 0xfff\ :\ 0x000;}
\DoxyCodeLine{00244\ \ \ \}}
\DoxyCodeLine{00245\ \}}
\DoxyCodeLine{00246\ }
\DoxyCodeLine{00247\ }
\DoxyCodeLine{00248\ \textcolor{comment}{//\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00249\ \textcolor{comment}{//\ Synchronize\ oscillators.}}
\DoxyCodeLine{00250\ \textcolor{comment}{//\ This\ must\ be\ done\ after\ all\ the\ oscillators\ have\ been\ clock()'ed\ since\ the}}
\DoxyCodeLine{00251\ \textcolor{comment}{//\ oscillators\ operate\ in\ parallel.}}
\DoxyCodeLine{00252\ \textcolor{comment}{//\ Note\ that\ the\ oscillators\ must\ be\ clocked\ exactly\ on\ the\ cycle\ when\ the}}
\DoxyCodeLine{00253\ \textcolor{comment}{//\ MSB\ is\ set\ high\ for\ hard\ sync\ to\ operate\ correctly.\ See\ SID::clock().}}
\DoxyCodeLine{00254\ \textcolor{comment}{//\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00255\ RESID\_INLINE}
\DoxyCodeLine{00256\ \textcolor{keywordtype}{void}\ WaveformGenerator::synchronize()}
\DoxyCodeLine{00257\ \{}
\DoxyCodeLine{00258\ \ \ \textcolor{comment}{//\ A\ special\ case\ occurs\ when\ a\ sync\ source\ is\ synced\ itself\ on\ the\ same}}
\DoxyCodeLine{00259\ \ \ \textcolor{comment}{//\ cycle\ as\ when\ its\ MSB\ is\ set\ high.\ In\ this\ case\ the\ destination\ will}}
\DoxyCodeLine{00260\ \ \ \textcolor{comment}{//\ not\ be\ synced.\ This\ has\ been\ verified\ by\ sampling\ OSC3.}}
\DoxyCodeLine{00261\ \ \ \textcolor{keywordflow}{if}\ (unlikely(msb\_rising)\ \&\&\ sync\_dest-\/>sync\ \&\&\ !(sync\ \&\&\ sync\_source-\/>msb\_rising))\ \{}
\DoxyCodeLine{00262\ \ \ \ \ sync\_dest-\/>accumulator\ =\ 0;}
\DoxyCodeLine{00263\ \ \ \}}
\DoxyCodeLine{00264\ \}}
\DoxyCodeLine{00265\ }
\DoxyCodeLine{00266\ }
\DoxyCodeLine{00267\ \textcolor{comment}{//\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00268\ \textcolor{comment}{//\ Waveform\ output.}}
\DoxyCodeLine{00269\ \textcolor{comment}{//\ The\ output\ from\ SID\ 8580\ is\ delayed\ one\ cycle\ compared\ to\ SID\ 6581;}}
\DoxyCodeLine{00270\ \textcolor{comment}{//\ this\ is\ only\ modeled\ for\ single\ cycle\ clocking\ (see\ sid.cc).}}
\DoxyCodeLine{00271\ \textcolor{comment}{//\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00272\ }
\DoxyCodeLine{00273\ \textcolor{comment}{//\ No\ waveform:}}
\DoxyCodeLine{00274\ \textcolor{comment}{//\ When\ no\ waveform\ is\ selected,\ the\ DAC\ input\ is\ floating.}}
\DoxyCodeLine{00275\ \textcolor{comment}{//}}
\DoxyCodeLine{00276\ }
\DoxyCodeLine{00277\ \textcolor{comment}{//\ Triangle:}}
\DoxyCodeLine{00278\ \textcolor{comment}{//\ The\ upper\ 12\ bits\ of\ the\ accumulator\ are\ used.}}
\DoxyCodeLine{00279\ \textcolor{comment}{//\ The\ MSB\ is\ used\ to\ create\ the\ falling\ edge\ of\ the\ triangle\ by\ inverting}}
\DoxyCodeLine{00280\ \textcolor{comment}{//\ the\ lower\ 11\ bits.\ The\ MSB\ is\ thrown\ away\ and\ the\ lower\ 11\ bits\ are}}
\DoxyCodeLine{00281\ \textcolor{comment}{//\ left-\/shifted\ (half\ the\ resolution,\ full\ amplitude).}}
\DoxyCodeLine{00282\ \textcolor{comment}{//\ Ring\ modulation\ substitutes\ the\ MSB\ with\ MSB\ EOR\ NOT\ sync\_source\ MSB.}}
\DoxyCodeLine{00283\ \textcolor{comment}{//}}
\DoxyCodeLine{00284\ }
\DoxyCodeLine{00285\ \textcolor{comment}{//\ Sawtooth:}}
\DoxyCodeLine{00286\ \textcolor{comment}{//\ The\ output\ is\ identical\ to\ the\ upper\ 12\ bits\ of\ the\ accumulator.}}
\DoxyCodeLine{00287\ \textcolor{comment}{//}}
\DoxyCodeLine{00288\ }
\DoxyCodeLine{00289\ \textcolor{comment}{//\ Pulse:}}
\DoxyCodeLine{00290\ \textcolor{comment}{//\ The\ upper\ 12\ bits\ of\ the\ accumulator\ are\ used.}}
\DoxyCodeLine{00291\ \textcolor{comment}{//\ These\ bits\ are\ compared\ to\ the\ pulse\ width\ register\ by\ a\ 12\ bit\ digital}}
\DoxyCodeLine{00292\ \textcolor{comment}{//\ comparator;\ output\ is\ either\ all\ one\ or\ all\ zero\ bits.}}
\DoxyCodeLine{00293\ \textcolor{comment}{//\ The\ pulse\ setting\ is\ delayed\ one\ cycle\ after\ the\ compare;\ this\ is\ only}}
\DoxyCodeLine{00294\ \textcolor{comment}{//\ modeled\ for\ single\ cycle\ clocking.}}
\DoxyCodeLine{00295\ \textcolor{comment}{//}}
\DoxyCodeLine{00296\ \textcolor{comment}{//\ The\ test\ bit,\ when\ set\ to\ one,\ holds\ the\ pulse\ waveform\ output\ at\ 0xfff}}
\DoxyCodeLine{00297\ \textcolor{comment}{//\ regardless\ of\ the\ pulse\ width\ setting.}}
\DoxyCodeLine{00298\ \textcolor{comment}{//}}
\DoxyCodeLine{00299\ }
\DoxyCodeLine{00300\ \textcolor{comment}{//\ Noise:}}
\DoxyCodeLine{00301\ \textcolor{comment}{//\ The\ noise\ output\ is\ taken\ from\ intermediate\ bits\ of\ a\ 23-\/bit\ shift\ register}}
\DoxyCodeLine{00302\ \textcolor{comment}{//\ which\ is\ clocked\ by\ bit\ 19\ of\ the\ accumulator.}}
\DoxyCodeLine{00303\ \textcolor{comment}{//\ The\ shift\ is\ delayed\ 2\ cycles\ after\ bit\ 19\ is\ set\ high;\ this\ is\ only}}
\DoxyCodeLine{00304\ \textcolor{comment}{//\ modeled\ for\ single\ cycle\ clocking.}}
\DoxyCodeLine{00305\ \textcolor{comment}{//}}
\DoxyCodeLine{00306\ \textcolor{comment}{//\ Operation:\ Calculate\ EOR\ result,\ shift\ register,\ set\ bit\ 0\ =\ result.}}
\DoxyCodeLine{00307\ \textcolor{comment}{//}}
\DoxyCodeLine{00308\ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ reset\ \ \ \ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00309\ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ |\ \ \ \ \ |\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ |}}
\DoxyCodeLine{00310\ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ \ \ test-\/-\/OR-\/-\/>EOR<-\/-\/\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ |}}
\DoxyCodeLine{00311\ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ |\ \ \ \ \ \ \ \ \ |\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ |}}
\DoxyCodeLine{00312\ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 2\ 2\ 2\ 1\ 1\ 1\ 1\ 1\ 1\ 1\ 1\ 1\ 1\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ |}}
\DoxyCodeLine{00313\ \textcolor{comment}{//\ Register\ bits:\ \ \ 2\ 1\ 0\ 9\ 8\ 7\ 6\ 5\ 4\ 3\ 2\ 1\ 0\ 9\ 8\ 7\ 6\ 5\ 4\ 3\ 2\ 1\ 0\ <-\/-\/-\/}}
\DoxyCodeLine{00314\ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ |\ \ \ |\ \ \ \ \ \ \ |\ \ \ \ \ |\ \ \ |\ \ \ \ \ \ \ |\ \ \ \ \ |\ \ \ |}}
\DoxyCodeLine{00315\ \textcolor{comment}{//\ Waveform\ bits:\ \ \ \ \ \ \ 1\ \ \ 1\ \ \ \ \ \ \ 9\ \ \ \ \ 8\ \ \ 7\ \ \ \ \ \ \ 6\ \ \ \ \ 5\ \ \ 4}}
\DoxyCodeLine{00316\ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 1\ \ \ 0}}
\DoxyCodeLine{00317\ \textcolor{comment}{//}}
\DoxyCodeLine{00318\ \textcolor{comment}{//\ The\ low\ 4\ waveform\ bits\ are\ zero\ (grounded).}}
\DoxyCodeLine{00319\ \textcolor{comment}{//}}
\DoxyCodeLine{00320\ }
\DoxyCodeLine{00321\ RESID\_INLINE\ \textcolor{keywordtype}{void}\ WaveformGenerator::clock\_shift\_register()}
\DoxyCodeLine{00322\ \{}
\DoxyCodeLine{00323\ \ \ \textcolor{comment}{//\ bit0\ =\ (bit22\ |\ test)\ \string^\ bit17}}
\DoxyCodeLine{00324\ \ \ reg24\ bit0\ =\ ((shift\_register\ >>\ 22)\ \string^\ (shift\_register\ >>\ 17))\ \&\ 0x1;}
\DoxyCodeLine{00325\ \ \ shift\_register\ =\ ((shift\_register\ <<\ 1)\ |\ bit0)\ \&\ 0x7fffff;}
\DoxyCodeLine{00326\ }
\DoxyCodeLine{00327\ \ \ \textcolor{comment}{//\ New\ noise\ waveform\ output.}}
\DoxyCodeLine{00328\ \ \ set\_noise\_output();}
\DoxyCodeLine{00329\ \}}
\DoxyCodeLine{00330\ }
\DoxyCodeLine{00331\ RESID\_INLINE\ \textcolor{keywordtype}{void}\ WaveformGenerator::write\_shift\_register()}
\DoxyCodeLine{00332\ \{}
\DoxyCodeLine{00333\ \ \ \textcolor{comment}{//\ Write\ changes\ to\ the\ shift\ register\ output\ caused\ by\ combined\ waveforms}}
\DoxyCodeLine{00334\ \ \ \textcolor{comment}{//\ back\ into\ the\ shift\ register.}}
\DoxyCodeLine{00335\ \ \ \textcolor{comment}{//\ A\ bit\ once\ set\ to\ zero\ cannot\ be\ changed,\ hence\ the\ and'ing.}}
\DoxyCodeLine{00336\ \ \ \textcolor{comment}{//\ FIXME:\ Write\ test\ program\ to\ check\ the\ effect\ of\ 1\ bits\ and\ whether}}
\DoxyCodeLine{00337\ \ \ \textcolor{comment}{//\ neighboring\ bits\ are\ affected.}}
\DoxyCodeLine{00338\ }
\DoxyCodeLine{00339\ \ \ shift\_register\ \&=}
\DoxyCodeLine{00340\ \ \ \ \ \string~((1<<20)|(1<<18)|(1<<14)|(1<<11)|(1<<9)|(1<<5)|(1<<2)|(1<<0))\ |}
\DoxyCodeLine{00341\ \ \ \ \ ((waveform\_output\ \&\ 0x800)\ <<\ 9)\ |\ \ \textcolor{comment}{//\ Bit\ 11\ -\/>\ bit\ 20}}
\DoxyCodeLine{00342\ \ \ \ \ ((waveform\_output\ \&\ 0x400)\ <<\ 8)\ |\ \ \textcolor{comment}{//\ Bit\ 10\ -\/>\ bit\ 18}}
\DoxyCodeLine{00343\ \ \ \ \ ((waveform\_output\ \&\ 0x200)\ <<\ 5)\ |\ \ \textcolor{comment}{//\ Bit\ \ 9\ -\/>\ bit\ 14}}
\DoxyCodeLine{00344\ \ \ \ \ ((waveform\_output\ \&\ 0x100)\ <<\ 3)\ |\ \ \textcolor{comment}{//\ Bit\ \ 8\ -\/>\ bit\ 11}}
\DoxyCodeLine{00345\ \ \ \ \ ((waveform\_output\ \&\ 0x080)\ <<\ 2)\ |\ \ \textcolor{comment}{//\ Bit\ \ 7\ -\/>\ bit\ \ 9}}
\DoxyCodeLine{00346\ \ \ \ \ ((waveform\_output\ \&\ 0x040)\ >>\ 1)\ |\ \ \textcolor{comment}{//\ Bit\ \ 6\ -\/>\ bit\ \ 5}}
\DoxyCodeLine{00347\ \ \ \ \ ((waveform\_output\ \&\ 0x020)\ >>\ 3)\ |\ \ \textcolor{comment}{//\ Bit\ \ 5\ -\/>\ bit\ \ 2}}
\DoxyCodeLine{00348\ \ \ \ \ ((waveform\_output\ \&\ 0x010)\ >>\ 4);\ \ \ \textcolor{comment}{//\ Bit\ \ 4\ -\/>\ bit\ \ 0}}
\DoxyCodeLine{00349\ }
\DoxyCodeLine{00350\ \ \ noise\_output\ \&=\ waveform\_output;}
\DoxyCodeLine{00351\ \ \ no\_noise\_or\_noise\_output\ =\ no\_noise\ |\ noise\_output;}
\DoxyCodeLine{00352\ \}}
\DoxyCodeLine{00353\ }
\DoxyCodeLine{00354\ RESID\_INLINE\ \textcolor{keywordtype}{void}\ WaveformGenerator::set\_noise\_output()}
\DoxyCodeLine{00355\ \{}
\DoxyCodeLine{00356\ \ \ \ \ noise\_output\ =\ (\textcolor{keywordtype}{unsigned}\ short)(((shift\_register\ \&\ 0x100000)\ >>\ 9)\ |}
\DoxyCodeLine{00357\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ((shift\_register\ \&\ 0x040000)\ >>\ 8)\ |}
\DoxyCodeLine{00358\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ((shift\_register\ \&\ 0x004000)\ >>\ 5)\ |}
\DoxyCodeLine{00359\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ((shift\_register\ \&\ 0x000800)\ >>\ 3)\ |}
\DoxyCodeLine{00360\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ((shift\_register\ \&\ 0x000200)\ >>\ 2)\ |}
\DoxyCodeLine{00361\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ((shift\_register\ \&\ 0x000020)\ <<\ 1)\ |}
\DoxyCodeLine{00362\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ((shift\_register\ \&\ 0x000004)\ <<\ 3)\ |}
\DoxyCodeLine{00363\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ((shift\_register\ \&\ 0x000001)\ <<\ 4)\ );}
\DoxyCodeLine{00364\ }
\DoxyCodeLine{00365\ \ \ no\_noise\_or\_noise\_output\ =\ no\_noise\ |\ noise\_output;}
\DoxyCodeLine{00366\ \}}
\DoxyCodeLine{00367\ }
\DoxyCodeLine{00368\ \textcolor{comment}{//\ Combined\ waveforms:}}
\DoxyCodeLine{00369\ \textcolor{comment}{//\ By\ combining\ waveforms,\ the\ bits\ of\ each\ waveform\ are\ effectively\ short}}
\DoxyCodeLine{00370\ \textcolor{comment}{//\ circuited.\ A\ zero\ bit\ in\ one\ waveform\ will\ result\ in\ a\ zero\ output\ bit}}
\DoxyCodeLine{00371\ \textcolor{comment}{//\ (thus\ the\ infamous\ claim\ that\ the\ waveforms\ are\ AND'ed).}}
\DoxyCodeLine{00372\ \textcolor{comment}{//\ However,\ a\ zero\ bit\ in\ one\ waveform\ may\ also\ affect\ the\ neighboring\ bits}}
\DoxyCodeLine{00373\ \textcolor{comment}{//\ in\ the\ output.}}
\DoxyCodeLine{00374\ \textcolor{comment}{//}}
\DoxyCodeLine{00375\ \textcolor{comment}{//\ Example:}}
\DoxyCodeLine{00376\ \textcolor{comment}{//}}
\DoxyCodeLine{00377\ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ \ \ \ \ 1\ 1}}
\DoxyCodeLine{00378\ \textcolor{comment}{//\ Bit\ \#\ \ \ \ \ \ \ 1\ 0\ 9\ 8\ 7\ 6\ 5\ 4\ 3\ 2\ 1\ 0}}
\DoxyCodeLine{00379\ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ \ \ \ \ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00380\ \textcolor{comment}{//\ Sawtooth\ \ \ \ 0\ 0\ 0\ 1\ 1\ 1\ 1\ 1\ 1\ 0\ 0\ 0}}
\DoxyCodeLine{00381\ \textcolor{comment}{//}}
\DoxyCodeLine{00382\ \textcolor{comment}{//\ Triangle\ \ \ \ 0\ 0\ 1\ 1\ 1\ 1\ 1\ 1\ 0\ 0\ 0\ 0}}
\DoxyCodeLine{00383\ \textcolor{comment}{//}}
\DoxyCodeLine{00384\ \textcolor{comment}{//\ AND\ \ \ \ \ \ \ \ \ 0\ 0\ 0\ 1\ 1\ 1\ 1\ 1\ 0\ 0\ 0\ 0}}
\DoxyCodeLine{00385\ \textcolor{comment}{//}}
\DoxyCodeLine{00386\ \textcolor{comment}{//\ Output\ \ \ \ \ \ 0\ 0\ 0\ 0\ 1\ 1\ 1\ 0\ 0\ 0\ 0\ 0}}
\DoxyCodeLine{00387\ \textcolor{comment}{//}}
\DoxyCodeLine{00388\ \textcolor{comment}{//}}
\DoxyCodeLine{00389\ \textcolor{comment}{//\ Re-\/vectorized\ die\ photographs\ reveal\ the\ mechanism\ behind\ this\ behavior.}}
\DoxyCodeLine{00390\ \textcolor{comment}{//\ Each\ waveform\ selector\ bit\ acts\ as\ a\ switch,\ which\ directly\ connects}}
\DoxyCodeLine{00391\ \textcolor{comment}{//\ internal\ outputs\ into\ the\ waveform\ DAC\ inputs\ as\ follows:}}
\DoxyCodeLine{00392\ \textcolor{comment}{//}}
\DoxyCodeLine{00393\ \textcolor{comment}{//\ *\ Noise\ outputs\ the\ shift\ register\ bits\ to\ DAC\ inputs\ as\ described\ above.}}
\DoxyCodeLine{00394\ \textcolor{comment}{//\ \ \ Each\ output\ is\ also\ used\ as\ input\ to\ the\ next\ bit\ when\ the\ shift\ register}}
\DoxyCodeLine{00395\ \textcolor{comment}{//\ \ \ is\ shifted.}}
\DoxyCodeLine{00396\ \textcolor{comment}{//\ *\ Pulse\ connects\ a\ single\ line\ to\ all\ DAC\ inputs.\ The\ line\ is\ connected\ to}}
\DoxyCodeLine{00397\ \textcolor{comment}{//\ \ \ either\ 5V\ (pulse\ on)\ or\ 0V\ (pulse\ off)\ at\ bit\ 11,\ and\ ends\ at\ bit\ 0.}}
\DoxyCodeLine{00398\ \textcolor{comment}{//\ *\ Triangle\ connects\ the\ upper\ 11\ bits\ of\ the\ (MSB\ EOR'ed)\ accumulator\ to\ the}}
\DoxyCodeLine{00399\ \textcolor{comment}{//\ \ \ DAC\ inputs,\ so\ that\ DAC\ bit\ 0\ =\ 0,\ DAC\ bit\ n\ =\ accumulator\ bit\ n\ -\/\ 1.}}
\DoxyCodeLine{00400\ \textcolor{comment}{//\ *\ Sawtooth\ connects\ the\ upper\ 12\ bits\ of\ the\ accumulator\ to\ the\ DAC\ inputs,}}
\DoxyCodeLine{00401\ \textcolor{comment}{//\ \ \ so\ that\ DAC\ bit\ n\ =\ accumulator\ bit\ n.\ Sawtooth\ blocks\ out\ the\ MSB\ from}}
\DoxyCodeLine{00402\ \textcolor{comment}{//\ \ \ the\ EOR\ used\ to\ generate\ the\ triangle\ waveform.}}
\DoxyCodeLine{00403\ \textcolor{comment}{//}}
\DoxyCodeLine{00404\ \textcolor{comment}{//\ We\ can\ thus\ draw\ the\ following\ conclusions:}}
\DoxyCodeLine{00405\ \textcolor{comment}{//}}
\DoxyCodeLine{00406\ \textcolor{comment}{//\ *\ The\ shift\ register\ may\ be\ written\ to\ by\ combined\ waveforms.}}
\DoxyCodeLine{00407\ \textcolor{comment}{//\ *\ The\ pulse\ waveform\ interconnects\ all\ bits\ in\ combined\ waveforms\ via\ the}}
\DoxyCodeLine{00408\ \textcolor{comment}{//\ \ \ pulse\ line.}}
\DoxyCodeLine{00409\ \textcolor{comment}{//\ *\ The\ combination\ of\ triangle\ and\ sawtooth\ interconnects\ neighboring\ bits}}
\DoxyCodeLine{00410\ \textcolor{comment}{//\ \ \ of\ the\ sawtooth\ waveform.}}
\DoxyCodeLine{00411\ \textcolor{comment}{//}}
\DoxyCodeLine{00412\ \textcolor{comment}{//\ This\ behavior\ would\ be\ quite\ difficult\ to\ model\ exactly,\ since\ the\ short}}
\DoxyCodeLine{00413\ \textcolor{comment}{//\ circuits\ are\ not\ binary,\ but\ are\ subject\ to\ analog\ effects.\ Tests\ show\ that}}
\DoxyCodeLine{00414\ \textcolor{comment}{//\ minor\ (1\ bit)\ differences\ can\ actually\ occur\ in\ the\ output\ from\ otherwise}}
\DoxyCodeLine{00415\ \textcolor{comment}{//\ identical\ samples\ from\ OSC3\ when\ waveforms\ are\ combined.\ To\ further}}
\DoxyCodeLine{00416\ \textcolor{comment}{//\ complicate\ the\ situation\ the\ output\ changes\ slightly\ with\ time\ (more}}
\DoxyCodeLine{00417\ \textcolor{comment}{//\ neighboring\ bits\ are\ successively\ set)\ when\ the\ 12-\/bit\ waveform}}
\DoxyCodeLine{00418\ \textcolor{comment}{//\ registers\ are\ kept\ unchanged.}}
\DoxyCodeLine{00419\ \textcolor{comment}{//}}
\DoxyCodeLine{00420\ \textcolor{comment}{//\ The\ output\ is\ instead\ approximated\ by\ using\ the\ upper\ bits\ of\ the}}
\DoxyCodeLine{00421\ \textcolor{comment}{//\ accumulator\ as\ an\ index\ to\ look\ up\ the\ combined\ output\ in\ a\ table}}
\DoxyCodeLine{00422\ \textcolor{comment}{//\ containing\ actual\ combined\ waveform\ samples\ from\ OSC3.}}
\DoxyCodeLine{00423\ \textcolor{comment}{//\ These\ samples\ are\ 8\ bit,\ so\ 4\ bits\ of\ waveform\ resolution\ is\ lost.}}
\DoxyCodeLine{00424\ \textcolor{comment}{//\ All\ OSC3\ samples\ are\ taken\ with\ FREQ=0x1000,\ adding\ a\ 1\ to\ the\ upper\ 12}}
\DoxyCodeLine{00425\ \textcolor{comment}{//\ bits\ of\ the\ accumulator\ each\ cycle\ for\ a\ sample\ period\ of\ 4096\ cycles.}}
\DoxyCodeLine{00426\ \textcolor{comment}{//}}
\DoxyCodeLine{00427\ \textcolor{comment}{//\ Sawtooth+Triangle:}}
\DoxyCodeLine{00428\ \textcolor{comment}{//\ The\ accumulator\ is\ used\ to\ look\ up\ an\ OSC3\ sample.}}
\DoxyCodeLine{00429\ \textcolor{comment}{//}}
\DoxyCodeLine{00430\ \textcolor{comment}{//\ Pulse+Triangle:}}
\DoxyCodeLine{00431\ \textcolor{comment}{//\ The\ accumulator\ is\ used\ to\ look\ up\ an\ OSC3\ sample.\ When\ ring\ modulation\ is}}
\DoxyCodeLine{00432\ \textcolor{comment}{//\ selected,\ the\ accumulator\ MSB\ is\ substituted\ with\ MSB\ EOR\ NOT\ sync\_source\ MSB.}}
\DoxyCodeLine{00433\ \textcolor{comment}{//}}
\DoxyCodeLine{00434\ \textcolor{comment}{//\ Pulse+Sawtooth:}}
\DoxyCodeLine{00435\ \textcolor{comment}{//\ The\ accumulator\ is\ used\ to\ look\ up\ an\ OSC3\ sample.}}
\DoxyCodeLine{00436\ \textcolor{comment}{//\ The\ sample\ is\ output\ if\ the\ pulse\ output\ is\ on.}}
\DoxyCodeLine{00437\ \textcolor{comment}{//}}
\DoxyCodeLine{00438\ \textcolor{comment}{//\ Pulse+Sawtooth+Triangle:}}
\DoxyCodeLine{00439\ \textcolor{comment}{//\ The\ accumulator\ is\ used\ to\ look\ up\ an\ OSC3\ sample.}}
\DoxyCodeLine{00440\ \textcolor{comment}{//\ The\ sample\ is\ output\ if\ the\ pulse\ output\ is\ on.}}
\DoxyCodeLine{00441\ \textcolor{comment}{//}}
\DoxyCodeLine{00442\ \textcolor{comment}{//\ Combined\ waveforms\ including\ noise:}}
\DoxyCodeLine{00443\ \textcolor{comment}{//\ All\ waveform\ combinations\ including\ noise\ output\ zero\ after\ a\ few\ cycles,}}
\DoxyCodeLine{00444\ \textcolor{comment}{//\ since\ the\ waveform\ bits\ are\ and'ed\ into\ the\ shift\ register\ via\ the\ shift}}
\DoxyCodeLine{00445\ \textcolor{comment}{//\ register\ outputs.}}
\DoxyCodeLine{00446\ }
\DoxyCodeLine{00447\ \textcolor{keyword}{static}\ reg12\ noise\_pulse6581(reg12\ noise)}
\DoxyCodeLine{00448\ \{}
\DoxyCodeLine{00449\ \ \ \ \ \textcolor{keywordflow}{return}\ (noise\ <\ 0xf00)\ ?\ 0x000\ :\ noise\ \&\ (noise<<1)\ \&\ (noise<<2);}
\DoxyCodeLine{00450\ \}}
\DoxyCodeLine{00451\ }
\DoxyCodeLine{00452\ \textcolor{keyword}{static}\ reg12\ noise\_pulse8580(reg12\ noise)}
\DoxyCodeLine{00453\ \{}
\DoxyCodeLine{00454\ \ \ \ \ \textcolor{keywordflow}{return}\ (noise\ <\ 0xfc0)\ ?\ noise\ \&\ (noise\ <<\ 1)\ :\ 0xfc0;}
\DoxyCodeLine{00455\ \}}
\DoxyCodeLine{00456\ }
\DoxyCodeLine{00457\ RESID\_INLINE}
\DoxyCodeLine{00458\ \textcolor{keywordtype}{void}\ WaveformGenerator::set\_waveform\_output()}
\DoxyCodeLine{00459\ \{}
\DoxyCodeLine{00460\ \ \ \textcolor{comment}{//\ Set\ output\ value.}}
\DoxyCodeLine{00461\ \ \ \textcolor{keywordflow}{if}\ (likely(waveform))\ \{}
\DoxyCodeLine{00462\ \ \ \ \ \textcolor{comment}{//\ The\ bit\ masks\ no\_pulse\ and\ no\_noise\ are\ used\ to\ achieve\ branch-\/free}}
\DoxyCodeLine{00463\ \ \ \ \ \textcolor{comment}{//\ calculation\ of\ the\ output\ value.}}
\DoxyCodeLine{00464\ \ \ \ \ \textcolor{keywordtype}{int}\ ix\ =\ (accumulator\ \string^\ (\string~sync\_source-\/>accumulator\ \&\ ring\_msb\_mask))\ >>\ 12;}
\DoxyCodeLine{00465\ }
\DoxyCodeLine{00466\ \ \ \ \ waveform\_output\ =\ wave[ix]\ \&\ (no\_pulse\ |\ pulse\_output)\ \&\ no\_noise\_or\_noise\_output;}
\DoxyCodeLine{00467\ }
\DoxyCodeLine{00468\ \ \ \ \ \textcolor{keywordflow}{if}\ (unlikely((waveform\ \&\ 0xc)\ ==\ 0xc))}
\DoxyCodeLine{00469\ \ \ \ \ \{}
\DoxyCodeLine{00470\ \ \ \ \ \ \ \ \ waveform\_output\ =\ (sid\_model\ ==\ MOS6581)\ ?}
\DoxyCodeLine{00471\ \ \ \ \ \ \ \ \ \ \ \ \ noise\_pulse6581(waveform\_output)\ :\ noise\_pulse8580(waveform\_output);}
\DoxyCodeLine{00472\ \ \ \ \ \}}
\DoxyCodeLine{00473\ }
\DoxyCodeLine{00474\ \ \ \ \ \textcolor{comment}{//\ Triangle/Sawtooth\ output\ is\ delayed\ half\ cycle\ on\ 8580.}}
\DoxyCodeLine{00475\ \ \ \ \ \textcolor{comment}{//\ This\ will\ appear\ as\ a\ one\ cycle\ delay\ on\ OSC3\ as\ it\ is}}
\DoxyCodeLine{00476\ \ \ \ \ \textcolor{comment}{//\ latched\ in\ the\ first\ phase\ of\ the\ clock.}}
\DoxyCodeLine{00477\ \ \ \ \ \textcolor{keywordflow}{if}\ ((waveform\ \&\ 3)\ \&\&\ (sid\_model\ ==\ MOS8580))}
\DoxyCodeLine{00478\ \ \ \ \ \{}
\DoxyCodeLine{00479\ \ \ \ \ \ \ \ \ osc3\ =\ tri\_saw\_pipeline\ \&\ (no\_pulse\ |\ pulse\_output)\ \&\ no\_noise\_or\_noise\_output;}
\DoxyCodeLine{00480\ \ \ \ \ \ \ \ \ tri\_saw\_pipeline\ =\ wave[ix];}
\DoxyCodeLine{00481\ \ \ \ \ \}}
\DoxyCodeLine{00482\ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{00483\ \ \ \ \ \{}
\DoxyCodeLine{00484\ \ \ \ \ \ \ \ \ osc3\ =\ waveform\_output;}
\DoxyCodeLine{00485\ \ \ \ \ \}}
\DoxyCodeLine{00486\ }
\DoxyCodeLine{00487\ \ \ \ \ \textcolor{keywordflow}{if}\ ((waveform\ \&\ 0x2)\ \&\&\ unlikely(waveform\ \&\ 0xd)\ \&\&\ (sid\_model\ ==\ MOS6581))\ \{}
\DoxyCodeLine{00488\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ In\ the\ 6581\ the\ top\ bit\ of\ the\ accumulator\ may\ be\ driven\ low\ by\ combined\ waveforms}}
\DoxyCodeLine{00489\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ when\ the\ sawtooth\ is\ selected}}
\DoxyCodeLine{00490\ \ \ \ \ \ \ \ \ accumulator\ \&=\ (waveform\_output\ <<\ 12)\ |\ 0x7fffff;}
\DoxyCodeLine{00491\ \ \ \ \ \}}
\DoxyCodeLine{00492\ }
\DoxyCodeLine{00493\ \ \ \ \ \textcolor{keywordflow}{if}\ (unlikely(waveform\ >\ 0x8)\ \&\&\ likely(!test)\ \&\&\ likely(shift\_pipeline\ !=\ 1))\ \{}
\DoxyCodeLine{00494\ \ \ \ \ \ \ \textcolor{comment}{//\ Combined\ waveforms\ write\ to\ the\ shift\ register.}}
\DoxyCodeLine{00495\ \ \ \ \ \ \ write\_shift\_register();}
\DoxyCodeLine{00496\ \ \ \ \ \}}
\DoxyCodeLine{00497\ \ \ \}}
\DoxyCodeLine{00498\ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00499\ \ \ \ \ \textcolor{comment}{//\ Age\ floating\ DAC\ input.}}
\DoxyCodeLine{00500\ \ \ \ \ \textcolor{keywordflow}{if}\ (likely(floating\_output\_ttl)\ \&\&\ unlikely(!-\/-\/floating\_output\_ttl))\ \{}
\DoxyCodeLine{00501\ \ \ \ \ \ \ wave\_bitfade();}
\DoxyCodeLine{00502\ \ \ \ \ \}}
\DoxyCodeLine{00503\ \ \ \}}
\DoxyCodeLine{00504\ }
\DoxyCodeLine{00505\ \ \ \textcolor{comment}{//\ The\ pulse\ level\ is\ defined\ as\ (accumulator\ >>\ 12)\ >=\ pw\ ?\ 0xfff\ :\ 0x000.}}
\DoxyCodeLine{00506\ \ \ \textcolor{comment}{//\ The\ expression\ -\/((accumulator\ >>\ 12)\ >=\ pw)\ \&\ 0xfff\ yields\ the\ same}}
\DoxyCodeLine{00507\ \ \ \textcolor{comment}{//\ results\ without\ any\ branching\ (and\ thus\ without\ any\ pipeline\ stalls).}}
\DoxyCodeLine{00508\ \ \ \textcolor{comment}{//\ NB!\ This\ expression\ relies\ on\ that\ the\ result\ of\ a\ boolean\ expression}}
\DoxyCodeLine{00509\ \ \ \textcolor{comment}{//\ is\ either\ 0\ or\ 1,\ and\ furthermore\ requires\ two's\ complement\ integer.}}
\DoxyCodeLine{00510\ \ \ \textcolor{comment}{//\ A\ few\ more\ cycles\ may\ be\ saved\ by\ storing\ the\ pulse\ width\ left\ shifted}}
\DoxyCodeLine{00511\ \ \ \textcolor{comment}{//\ 12\ bits,\ and\ dropping\ the\ and\ with\ 0xfff\ (this\ is\ valid\ since\ pulse\ is}}
\DoxyCodeLine{00512\ \ \ \textcolor{comment}{//\ used\ as\ a\ bit\ mask\ on\ 12\ bit\ values),\ yielding\ the\ expression}}
\DoxyCodeLine{00513\ \ \ \textcolor{comment}{//\ -\/(accumulator\ >=\ pw24).\ However\ this\ only\ results\ in\ negligible\ savings.}}
\DoxyCodeLine{00514\ }
\DoxyCodeLine{00515\ \ \ \textcolor{comment}{//\ The\ result\ of\ the\ pulse\ width\ compare\ is\ delayed\ one\ cycle.}}
\DoxyCodeLine{00516\ \ \ \textcolor{comment}{//\ Push\ next\ pulse\ level\ into\ pulse\ level\ pipeline.}}
\DoxyCodeLine{00517\ \ \ pulse\_output\ =\ -\/((accumulator\ >>\ 12)\ >=\ pw)\ \&\ 0xfff;}
\DoxyCodeLine{00518\ \}}
\DoxyCodeLine{00519\ }
\DoxyCodeLine{00520\ RESID\_INLINE}
\DoxyCodeLine{00521\ \textcolor{keywordtype}{void}\ WaveformGenerator::set\_waveform\_output(cycle\_count\ delta\_t)}
\DoxyCodeLine{00522\ \{}
\DoxyCodeLine{00523\ \ \ \textcolor{comment}{//\ Set\ output\ value.}}
\DoxyCodeLine{00524\ \ \ \textcolor{keywordflow}{if}\ (likely(waveform))\ \{}
\DoxyCodeLine{00525\ \ \ \ \ \textcolor{comment}{//\ The\ bit\ masks\ no\_pulse\ and\ no\_noise\ are\ used\ to\ achieve\ branch-\/free}}
\DoxyCodeLine{00526\ \ \ \ \ \textcolor{comment}{//\ calculation\ of\ the\ output\ value.}}
\DoxyCodeLine{00527\ \ \ \ \ \textcolor{keywordtype}{int}\ ix\ =\ (accumulator\ \string^\ (\string~sync\_source-\/>accumulator\ \&\ ring\_msb\_mask))\ >>\ 12;}
\DoxyCodeLine{00528\ \ \ \ \ waveform\_output\ =}
\DoxyCodeLine{00529\ \ \ \ \ \ \ wave[ix]\ \&\ (no\_pulse\ |\ pulse\_output)\ \&\ no\_noise\_or\_noise\_output;}
\DoxyCodeLine{00530\ \ \ \ \ \textcolor{comment}{//\ Triangle/Sawtooth\ output\ delay\ for\ the\ 8580\ is\ not\ modeled}}
\DoxyCodeLine{00531\ \ \ \ \ osc3\ =\ waveform\_output;}
\DoxyCodeLine{00532\ }
\DoxyCodeLine{00533\ \ \ \ \ \textcolor{keywordflow}{if}\ ((waveform\ \&\ 0x2)\ \&\&\ unlikely(waveform\ \&\ 0xd)\ \&\&\ (sid\_model\ ==\ MOS6581))\ \{}
\DoxyCodeLine{00534\ \ \ \ \ \ \ \ \ accumulator\ \&=\ (waveform\_output\ <<\ 12)\ |\ 0x7fffff;}
\DoxyCodeLine{00535\ \ \ \ \ \}}
\DoxyCodeLine{00536\ }
\DoxyCodeLine{00537\ \ \ \ \ \textcolor{keywordflow}{if}\ (unlikely(waveform\ >\ 0x8)\ \&\&\ likely(!test))\ \{}
\DoxyCodeLine{00538\ \ \ \ \ \ \ \textcolor{comment}{//\ Combined\ waveforms\ write\ to\ the\ shift\ register.}}
\DoxyCodeLine{00539\ \ \ \ \ \ \ \textcolor{comment}{//\ NB!\ Since\ cycles\ are\ skipped\ in\ delta\_t\ clocking,\ writes\ will\ be}}
\DoxyCodeLine{00540\ \ \ \ \ \ \ \textcolor{comment}{//\ missed.\ Single\ cycle\ clocking\ must\ be\ used\ for\ 100\%\ correct\ operation.}}
\DoxyCodeLine{00541\ \ \ \ \ \ \ write\_shift\_register();}
\DoxyCodeLine{00542\ \ \ \ \ \}}
\DoxyCodeLine{00543\ \ \ \}}
\DoxyCodeLine{00544\ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00545\ \ \ \ \ \textcolor{keywordflow}{if}\ (likely(floating\_output\_ttl))\ \{}
\DoxyCodeLine{00546\ \ \ \ \ \ \ \textcolor{comment}{//\ Age\ floating\ D/A\ output.}}
\DoxyCodeLine{00547\ \ \ \ \ \ \ floating\_output\_ttl\ -\/=\ delta\_t;}
\DoxyCodeLine{00548\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (unlikely(floating\_output\_ttl\ <=\ 0))\ \{}
\DoxyCodeLine{00549\ \ \ \ \ \ \ \ \ floating\_output\_ttl\ =\ 0;}
\DoxyCodeLine{00550\ \ \ \ \ \ \ \ \ osc3\ =\ waveform\_output\ =\ 0;}
\DoxyCodeLine{00551\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00552\ \ \ \ \ \}}
\DoxyCodeLine{00553\ \ \ \}}
\DoxyCodeLine{00554\ \}}
\DoxyCodeLine{00555\ }
\DoxyCodeLine{00556\ }
\DoxyCodeLine{00557\ \textcolor{comment}{//\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00558\ \textcolor{comment}{//\ Waveform\ output\ (12\ bits).}}
\DoxyCodeLine{00559\ \textcolor{comment}{//\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00560\ }
\DoxyCodeLine{00561\ \textcolor{comment}{//\ The\ digital\ waveform\ output\ is\ converted\ to\ an\ analog\ signal\ by\ a\ 12-\/bit}}
\DoxyCodeLine{00562\ \textcolor{comment}{//\ DAC.\ Re-\/vectorized\ die\ photographs\ reveal\ that\ the\ DAC\ is\ an\ R-\/2R\ ladder}}
\DoxyCodeLine{00563\ \textcolor{comment}{//\ built\ up\ as\ follows:}}
\DoxyCodeLine{00564\ \textcolor{comment}{//}}
\DoxyCodeLine{00565\ \textcolor{comment}{//\ \ \ \ \ \ \ \ 12V\ \ \ \ \ 11\ \ 10\ \ \ 9\ \ \ 8\ \ \ 7\ \ \ 6\ \ \ 5\ \ \ 4\ \ \ 3\ \ \ 2\ \ \ 1\ \ \ 0\ \ \ \ GND}}
\DoxyCodeLine{00566\ \textcolor{comment}{//\ Strange\ \ |\ \ \ \ \ \ |\ \ \ |\ \ \ |\ \ \ |\ \ \ |\ \ \ |\ \ \ |\ \ \ |\ \ \ |\ \ \ |\ \ \ |\ \ \ |\ \ \ \ \ |\ \ Missing}}
\DoxyCodeLine{00567\ \textcolor{comment}{//\ part\ \ \ \ 2R\ \ \ \ \ 2R\ \ 2R\ \ 2R\ \ 2R\ \ 2R\ \ 2R\ \ 2R\ \ 2R\ \ 2R\ \ 2R\ \ 2R\ \ 2R\ \ \ \ 2R\ \ term.}}
\DoxyCodeLine{00568\ \textcolor{comment}{//\ (bias)\ \ \ |\ \ \ \ \ \ |\ \ \ |\ \ \ |\ \ \ |\ \ \ |\ \ \ |\ \ \ |\ \ \ |\ \ \ |\ \ \ |\ \ \ |\ \ \ |\ \ \ \ \ |}}
\DoxyCodeLine{00569\ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ \ -\/-\/R-\/\ \ \ -\/-\/R-\/-\/-\/R-\/-\/-\/R-\/-\/-\/R-\/-\/-\/R-\/-\/-\/R-\/-\/-\/R-\/-\/-\/R-\/-\/-\/R-\/-\/-\/R-\/-\/-\/R-\/-\/\ \ \ -\/-\/-\/}}
\DoxyCodeLine{00570\ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ |\ \ \ \ \ \ \ \ \ \ \_\_\_\_\_}}
\DoxyCodeLine{00571\ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_\_|\_\_\ \ \ \ \ \_\_|\_\_\ \ \ |}}
\DoxyCodeLine{00572\ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ -\/-\/-\/-\/-\/\ \ \ \ \ =====\ \ \ |}}
\DoxyCodeLine{00573\ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ |\ \ \ |\ \ \ \ \ |\ \ \ |\ \ \ |}}
\DoxyCodeLine{00574\ \textcolor{comment}{//\ \ \ \ \ \ \ \ 12V\ -\/-\/-\/\ \ \ \ \ -\/-\/-\/-\/-\/\ \ \ \ \ -\/-\/-\/-\/-\/-\/-\/\ GND}}
\DoxyCodeLine{00575\ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ |}}
\DoxyCodeLine{00576\ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ wout}}
\DoxyCodeLine{00577\ \textcolor{comment}{//}}
\DoxyCodeLine{00578\ \textcolor{comment}{//\ Bit\ on:\ \ 5V}}
\DoxyCodeLine{00579\ \textcolor{comment}{//\ Bit\ off:\ 0V\ (GND)}}
\DoxyCodeLine{00580\ \textcolor{comment}{//}}
\DoxyCodeLine{00581\ \textcolor{comment}{//\ As\ is\ the\ case\ with\ all\ MOS\ 6581\ DACs,\ the\ termination\ to\ (virtual)\ ground}}
\DoxyCodeLine{00582\ \textcolor{comment}{//\ at\ bit\ 0\ is\ missing.\ The\ MOS\ 8580\ has\ correct\ termination,\ and\ has\ also}}
\DoxyCodeLine{00583\ \textcolor{comment}{//\ done\ away\ with\ the\ bias\ part\ on\ the\ left\ hand\ side\ of\ the\ figure\ above.}}
\DoxyCodeLine{00584\ \textcolor{comment}{//}}
\DoxyCodeLine{00585\ }
\DoxyCodeLine{00586\ RESID\_INLINE}
\DoxyCodeLine{00587\ \textcolor{keywordtype}{short}\ WaveformGenerator::output()}
\DoxyCodeLine{00588\ \{}
\DoxyCodeLine{00589\ \ \ \textcolor{comment}{//\ DAC\ imperfections\ are\ emulated\ by\ using\ waveform\_output\ as\ an\ index}}
\DoxyCodeLine{00590\ \ \ \textcolor{comment}{//\ into\ a\ DAC\ lookup\ table.\ readOSC()\ uses\ waveform\_output\ directly.}}
\DoxyCodeLine{00591\ \ \ \textcolor{keywordflow}{return}\ model\_dac[sid\_model][waveform\_output];}
\DoxyCodeLine{00592\ \}}
\DoxyCodeLine{00593\ }
\DoxyCodeLine{00594\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ RESID\_INLINING\ ||\ defined(RESID\_WAVE\_CC)}}
\DoxyCodeLine{00595\ }
\DoxyCodeLine{00596\ \}\ \textcolor{comment}{//\ namespace\ reSID}}
\DoxyCodeLine{00597\ }
\DoxyCodeLine{00598\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ not\ RESID\_WAVE\_H}}

\end{DoxyCode}
